<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convert PDFs to Dark Mode â€“ Secure, Local & Private Offline Tool</title>
    <meta name="description" content="Instantly convert your PDFs to dark mode with our free, privacy-focused offline tool. Enjoy a comfortable night mode reading experience without any uploadsâ€”your data stays local and secure.">
    <meta name="keywords" content="PDF dark mode, dark mode PDF, offline PDF converter, local PDF conversion, private PDF tool, secure PDF reader, night mode PDF, no-upload PDF converter">
    <meta name="author" content="Chizkiyahu">
    <meta property="og:title" content="Convert PDFs to Dark Mode â€“ Secure, Local & Private Offline Tool">
    <meta property="og:description" content="Easily convert PDFs to dark mode with our free, no-upload tool. Reduce eye strain while keeping your documents private with local conversion.">
    <meta property="og:url" content="https://chizkiyahu.github.io/pdf-dark-mode-converter/">
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "SoftwareApplication",
        "name": "PDF Dark Mode Converter",
        "description": "A free online tool to convert PDFs to dark mode, reducing eye strain.",
        "applicationCategory": "Utility",
        "operatingSystem": "Web-based",
        "url": "https://chizkiyahu.github.io/pdf-dark-mode-converter/",
        "author": {
            "@type": "Person",
            "name": "Chizkiyahu"
        }
    }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        // Set worker source for pdf.js - This can run early
        pdfjsLib.GlobalWorkerOptions.workerSrc ="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js"
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js" integrity="sha512-z8IYLHO8bTgFBCj+4jGjPskhQpYF5dM4MFxCjPMMWnEu76xM0QhM+3BHU5jM3RjWdXjTzqaVnLwHj4PzQhYQYw==" crossorigin="anonymous" referrerpolicy="no-referrer" defer></script>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <style>
        /* Basic styling for the page */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            text-align: center;
            background-color: #1e1e1e; /* Dark background */
            color: #e0e0e0; /* Light text */
            padding: 20px;
            line-height: 1.6;
            display: flex; /* Use flexbox for centering */
            flex-direction: column; /* Stack elements vertically */
            align-items: center; /* Center horizontally */
            min-height: 100vh; /* Ensure body takes full viewport height */
            box-sizing: border-box;
        }
        html {
            height: 100%;
        }

        .container {
            max-width: 800px;
            width: 90%; /* Responsive width */
            margin: 20px auto;
            padding: 25px 30px; /* Increased padding */
            background-color: #2a2a2a;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4); /* Slightly stronger shadow */
            flex-grow: 1; /* Allow container to grow */
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .notice {
            background-color: #333;
            padding: 15px;
            border-radius: 5px;
            margin: 0 auto 30px auto; /* Increased bottom margin */
            font-size: 0.9em;
            color: #ccc;
            max-width: 95%; /* Slightly wider */
            border-left: 4px solid #007bff;
            text-align: left; /* Align text left for readability */
        }
        /* Hide default file input */
        .file-input {
            display: none;
        }
        /* Style the custom upload button */
        .custom-file-upload {
            display: inline-block;
            padding: 12px 25px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-bottom: 25px; /* Increased spacing */
            transition: background-color 0.3s ease, transform 0.2s ease; /* Added transform transition */
        }
        .custom-file-upload:hover {
            background-color: #0056b3;
            transform: translateY(-2px); /* Slight lift on hover */
        }
        /* Progress bar styling */
        #progressContainer {
            width: 90%;
            max-width: 500px;
            background-color: #444;
            border-radius: 5px;
            margin: 25px auto; /* Increased spacing */
            padding: 5px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
            display: none; /* Hidden by default */
        }
        #progressBar {
            height: 24px;
            background: linear-gradient(90deg, #007bff, #0056b3); /* Gradient background */
            width: 0; /* Start at 0 width */
            text-align: center;
            line-height: 24px;
            color: white;
            font-weight: bold;
            border-radius: 3px;
            transition: width 0.4s ease;
        }
        #progressText {
            margin-top: 8px;
            color: #ccc;
            font-weight: bold;
            font-size: 0.9em;
        }
        /* Download button styling */
        #downloadBtn {
            margin-top: 30px; /* Increased spacing */
            padding: 12px 25px;
            background-color: #28a745; /* Green color */
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            display: none; /* Hidden by default */
            transition: background-color 0.3s ease, transform 0.2s ease; /* Added transform transition */
        }
        #downloadBtn:hover {
            background-color: #218838;
            transform: translateY(-2px); /* Slight lift on hover */
        }
        /* GitHub ribbon styling */
        .github-ribbon {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            border: 0;
        }
        .github-ribbon img{
             width: 149px;
             height: 149px;
             /* Improved accessibility */
             image-rendering: -webkit-optimize-contrast; /* Better rendering on some browsers */
             image-rendering: crisp-edges;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            body {
                padding: 10px; /* Reduced padding on small screens */
            }
            .container {
                width: 95%;
                padding: 20px;
            }
            .notice {
                font-size: 0.85em;
                margin-bottom: 20px;
            }
            .custom-file-upload, #downloadBtn {
                padding: 10px 20px;
                font-size: 0.95em;
                width: 80%; /* Make buttons wider */
                box-sizing: border-box; /* Include padding in width */
            }
             /* Move ribbon to bottom right on smaller screens */
            .github-ribbon {
                top: auto;
                bottom: 0;
                right: 0;
                left: auto;
            }
            .github-ribbon img {
                width: 100px; /* Smaller ribbon */
                height: 100px;
            }
        }
         @media (max-width: 480px) {
             h1 {
                 font-size: 1.5em;
             }
             .container {
                 padding: 15px;
             }
         }
    </style>
</head>
<body>
    <a href="https://github.com/Chizkiyahu/pdf-dark-mode-converter" class="github-ribbon" aria-label="View source on GitHub">
        <img decoding="async" width="149" height="149" src="https://github.blog/wp-content/uploads/2008/12/forkme_left_red_aa0000.png?resize=149%2C149" alt="Fork me on GitHub" loading="lazy">
    </a>

    <div class="container">
        <div class="notice">
            ðŸ”’ This tool runs completely on your device. No data is uploaded or sent to any server. Your privacy is 100% protected.
        </div>
        <h1>PDF Dark Mode Converter</h1>

        <label for="fileInput" class="custom-file-upload">Choose PDF File or Drag Here</label>
        <input type="file" id="fileInput" class="file-input" accept="application/pdf">

        <div id="progressContainer">
            <div id="progressBar">0%</div> <div id="progressText">Processing...</div>
        </div>

        <button id="downloadBtn">Download Dark Mode PDF</button>

        <div id="pdfContainer"></div>
    </div>

    <script>
        // Global variables
        let modifiedPdfBytes = null;
        let originalFileName = "";

        // --- Wait for the DOM and deferred scripts to be ready ---
        document.addEventListener('DOMContentLoaded', function() {

            // DOM element references - get them once the DOM is ready
            const fileInputElement = document.getElementById('fileInput');
            const downloadButton = document.getElementById('downloadBtn');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const bodyElement = document.body; // Reference to body for drag/drop styling

            /**
             * Handles the selected file (from input or drag/drop).
             * Reads the file and starts the PDF processing.
             * @param {File} file - The PDF file selected by the user.
             */
            function handleFile(file) {
                if (!file || file.type !== 'application/pdf') {
                    alert('Please select a valid PDF file.');
                    resetUI();
                    return;
                }
                originalFileName = file.name.replace(/\.pdf$/i, '');
                modifiedPdfBytes = null;
                downloadButton.style.display = 'none';

                const fileReader = new FileReader();
                progressContainer.style.display = 'block';
                progressBar.style.width = '0%';
                progressBar.innerText = '0%';
                progressText.innerText = 'Reading file...';

                fileReader.onload = async function() {
                    // Check if PDFLib is loaded *before* calling processPDF
                    if (typeof PDFLib === 'undefined') {
                         console.error('PDFLib is still not defined!');
                         alert('Error: PDF processing library failed to load. Please refresh the page and try again.');
                         resetUI();
                         return; // Stop execution
                    }
                    try {
                        progressText.innerText = 'Processing PDF...';
                        await processPDF(new Uint8Array(this.result));
                    } catch (error) {
                        console.error("Error during file processing:", error);
                        alert(`An error occurred while processing the PDF: ${error.message}. Please try a different file.`);
                        resetUI();
                    }
                };
                fileReader.onerror = function() {
                    console.error("Error reading file:", fileReader.error);
                    alert("An error occurred while reading the file.");
                    resetUI();
                };
                fileReader.readAsArrayBuffer(file);
            }

            /**
             * Resets the UI elements to their initial state.
             */
            function resetUI() {
                progressContainer.style.display = 'none';
                progressBar.style.width = '0%';
                progressBar.innerText = '0%';
                downloadButton.style.display = 'none';
                if(fileInputElement) {
                    fileInputElement.value = ''; // Clear the file input only if it exists
                }
            }

            // --- Event Listeners (Setup inside DOMContentLoaded) ---

            if(fileInputElement) {
                fileInputElement.addEventListener('change', function(event) {
                    if (event.target.files.length > 0) {
                        handleFile(event.target.files[0]);
                    }
                });
            } else {
                console.error("File input element not found!");
            }


            bodyElement.addEventListener('dragover', function(event) {
                event.preventDefault();
                bodyElement.style.backgroundColor = '#333'; // Visual feedback
            });
            bodyElement.addEventListener('dragleave', function(event) {
                bodyElement.style.backgroundColor = '#1e1e1e'; // Reset visual feedback
            });
            bodyElement.addEventListener('drop', function(event) {
                event.preventDefault();
                bodyElement.style.backgroundColor = '#1e1e1e'; // Reset visual feedback
                if (event.dataTransfer.files.length > 0) {
                    // Check if dropped item is a file and is a PDF
                     const file = event.dataTransfer.files[0];
                     if (file.type === 'application/pdf') {
                         handleFile(file);
                     } else {
                         alert('Please drop a valid PDF file.');
                     }
                }
            });

            if (downloadButton) {
                 downloadButton.addEventListener('click', triggerDownload);
            } else {
                 console.error("Download button element not found!");
            }


            // --- Core PDF Processing Logic ---

            /**
             * Processes the PDF data to attempt color inversion using pdf-lib.
             * NOTE: This direct content stream modification is experimental.
             * @param {Uint8Array} pdfData - The raw byte data of the PDF file.
             */
            async function processPDF(pdfData) {
                // pdf-lib should be defined here thanks to DOMContentLoaded and the check in handleFile
                const { PDFDocument } = PDFLib;

                try {
                    const pdfDoc = await PDFDocument.load(pdfData, { ignoreEncryption: true }); // Added ignoreEncryption tentatively
                    const numPages = pdfDoc.getPageCount();

                    for (let i = 0; i < numPages; i++) {
                        const progress = ((i + 1) / numPages) * 100;
                        progressBar.style.width = `${progress}%`;
                        progressBar.innerText = `${Math.round(progress)}%`;
                        progressText.innerText = `Processing page ${i + 1}/${numPages}...`;

                        const page = pdfDoc.getPage(i);
                        try {
                            const contentStream = page.getContentStream();
                            if (contentStream) {
                                const operators = contentStream.getOperators();
                                operators.forEach(op => {
                                    // Attempt to invert RGB fill (rg)
                                    if (op.name === 'rg' && op.args.length === 3) {
                                        op.args = op.args.map(c => Math.max(0, Math.min(1, 1.0 - c)));
                                    }
                                    // Attempt to invert RGB stroke (RG)
                                    else if (op.name === 'RG' && op.args.length === 3) {
                                         op.args = op.args.map(c => Math.max(0, Math.min(1, 1.0 - c)));
                                    }
                                    // Attempt to invert Grayscale fill (g)
                                    else if (op.name === 'g' && op.args.length === 1) {
                                         op.args[0] = Math.max(0, Math.min(1, 1.0 - op.args[0]));
                                    }
                                    // Attempt to invert Grayscale stroke (G)
                                    else if (op.name === 'G' && op.args.length === 1) {
                                         op.args[0] = Math.max(0, Math.min(1, 1.0 - op.args[0]));
                                    }
                                    // Basic CMYK inversion (k, K operators - may need more complex logic)
                                    else if (op.name === 'k' && op.args.length === 4) { // CMYK fill
                                        // Simple inversion - might not look great
                                        op.args = op.args.map(c => Math.max(0, Math.min(1, 1.0 - c)));
                                    }
                                     else if (op.name === 'K' && op.args.length === 4) { // CMYK stroke
                                        op.args = op.args.map(c => Math.max(0, Math.min(1, 1.0 - c)));
                                    }
                                });
                                contentStream.setOperators(operators);
                            }
                        } catch (pageError) {
                            console.warn(`Could not process content stream for page ${i + 1}: ${pageError.message}. Skipping page modification.`);
                        }
                        await new Promise(resolve => setTimeout(resolve, 0)); // Yield for UI updates
                    }

                    progressText.innerText = 'Finalizing...';
                    progressBar.style.width = '100%';
                    progressBar.innerText = '100%';

                    modifiedPdfBytes = await pdfDoc.save();
                    progressContainer.style.display = 'none'; // Hide progress
                    if (downloadButton) downloadButton.style.display = 'inline-block'; // Show download button

                } catch (error) {
                    console.error("Error processing PDF with pdf-lib:", error);
                    if (error.message.includes('encrypted')) {
                        alert("Could not process the PDF because it is encrypted or password-protected.");
                    } else {
                        alert(`An error occurred while processing the PDF: ${error.message}. The file might be corrupted or use unsupported features.`);
                    }
                    resetUI();
                }
            }

            /**
             * Triggers the download of the modified PDF file.
             */
            function triggerDownload() {
                if (modifiedPdfBytes) {
                    const blob = new Blob([modifiedPdfBytes], { type: 'application/pdf' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `${originalFileName}_dark_mode.pdf`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                } else {
                    alert("No modified PDF available to download. Please process a file first.");
                }
            }

            // --- Initial UI Reset ---
            resetUI(); // Ensure clean state on load

        }); // End of DOMContentLoaded listener

    </script>
</body>
</html>
